#! /usr/bin/perl
#
$in="switch-orgs.in";



%certnames = (
"1ff790e2" => "",
"47d3d1a0" => "",
"770cd2b7" => "",
"eebc7717" => ""
);

open IN,"$in" or die "Cannot open $in: $!\n";
while (<IN>) {
  chomp($_);
  push @orgs,"/C=CH/$_/*";
}
close IN;

foreach $k ( sort keys %certnames ) {
  $nm=`openssl x509 -subject -noout -in $k.0`;
  chomp($nm);
  $nm=~s/^subject=\s+//;
  $certnames{$k}=$nm;
}

#1ff790e2.0: subject= /C=CH/O=SwissSign AG/CN=SwissSign Silver CA
#47d3d1a0.0: subject= /C=CH/O=Switch - Teleinformatikdienste fuer Lehre und Forschung/CN=SWITCH Personal CA
#770cd2b7.0: subject= /C=CH/O=Switch - Teleinformatikdienste fuer Lehre und Forschung/CN=SWITCH CA
#eebc7717.0: subject= /C=CH/O=Switch - Teleinformatikdienste fuer Lehre und Forschung/CN=SWITCH Server CA

foreach $k ( sort keys %certnames ) {
  open SP,">$k.signing_policy" or die "Cannot open $k for write: $!\n";

  foreach ( $certnames{$k} ) {
    /SwissSign Silver CA/ and @targets=( $certnames{"770cd2b7"} );
    /SWITCH CA/ and @targets=( $certnames{"47d3d1a0"} , $certnames{"eebc7717"} );
    /SWITCH \w+ CA/ and @targets = @orgs;
  }


  print SP "##############################################################################\n";
  print SP "# Autogenerated EACL for $k from $in\n";
  print SP "# @(#)\$Id\$\n#\n";
  foreach $nm ( sort @targets ) {
    $canm=$certnames{$k};
    print SP "# --- for $nm\n";
    print SP " access_id_CA  X509    '$canm'\n";
    print SP " pos_rights    globus  CA:sign\n";
    print SP " cond_subjects globus  '\"$nm\"'\n";
    ( ($canm =~ /emailAddress=/) or ($nm =~ /emailAddress=/) ) and do {
      $canm =~ s/emailAddress=/Email=/g;
      $nm   =~ s/emailAddress=/Email=/g;
      print SP "#\n";
      print SP " access_id_CA  X509    '$canm'\n";
      print SP " pos_rights    globus  CA:sign\n";
      print SP " cond_subjects globus  '\"$nm\"'\n";
    };
    print SP "#\n";
  }

  close SP;
}
